<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Web Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* WhatsApp Benzeri Sohbet Stilleri */
        .chat-container {
            background-color: #e5ddd5;
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyBAMAAADsEZWCAAAAG1BMVEXMzMyWlpaxsbGqqqq3t7ejo6OcnJy+vr7FxcXPKca5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAOklEQVQ4jWNgGAUjFSgwMDBUMDAwoEkxMDAwMjAwoEsxMTExMDCgSzExMTMyMKBJMTMzMzAwoEsNKQAAKg0FDf16GDoAAAAASUVORK5CYII=");
            min-height: 450px;
            max-height: 450px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 0;
        }

        .message-row {
            display: flex;
            margin-bottom: 6px;
        }

        .message-row.sent {
            justify-content: flex-end;
        }

        .message-row.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 65%;
            padding: 6px 10px 8px 10px;
            border-radius: 7.5px;
            position: relative;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            word-wrap: break-word;
        }

        .message-bubble.sent {
            background-color: #d9fdd3;
            border-top-right-radius: 0;
        }

        .message-bubble.received {
            background-color: #ffffff;
            border-top-left-radius: 0;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 500;
            color: #06cf9c;
            margin-bottom: 2px;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
            color: #111b21;
        }

        .message-time {
            font-size: 11px;
            color: #667781;
            text-align: right;
            margin-top: 3px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 3px;
        }

        .message-time .bi-check2-all {
            color: #53bdeb;
        }

        .message-media img {
            max-width: 280px;
            border-radius: 6px;
            cursor: pointer;
            display: block;
            margin-bottom: 4px;
        }

        .message-media video {
            max-width: 280px;
            border-radius: 6px;
            display: block;
            margin-bottom: 4px;
        }

        .message-media audio {
            width: 240px;
            height: 36px;
            margin-bottom: 4px;
        }

        .message-document {
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.04);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            min-width: 200px;
        }

        .message-document .doc-icon {
            width: 40px;
            height: 48px;
            background: #e74c3c;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .message-document .doc-info {
            flex: 1;
            min-width: 0;
        }

        .message-document .doc-name {
            font-size: 13px;
            color: #111b21;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .message-document .doc-link {
            font-size: 12px;
            color: #667781;
        }

        /* Chat Header */
        .chat-header {
            background: #f0f2f5;
            padding: 10px 15px;
            border-bottom: 1px solid #e9edef;
            display: flex;
            align-items: center;
        }

        .chat-header .avatar {
            width: 40px;
            height: 40px;
            background: #dfe5e7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }

        .chat-header .avatar i {
            font-size: 24px;
            color: #adb5bd;
        }

        .chat-header .chat-name {
            font-weight: 500;
            font-size: 16px;
            color: #111b21;
        }

        /* Chat Footer */
        .chat-footer {
            background: #f0f2f5;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-footer input {
            border-radius: 8px;
            border: none;
            padding: 10px 15px;
        }

        .chat-footer .btn-send {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Media Lightbox */
        .media-lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            cursor: pointer;
        }

        .media-lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 4px;
        }

        /* Scroll to bottom button */
        .scroll-bottom-btn {
            position: absolute;
            bottom: 70px;
            right: 20px;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            display: none;
            z-index: 10;
        }

        /* Drive Status */
        .drive-status-ok { color: #28a745; }
        .drive-status-error { color: #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-success">
        <div class="container-fluid">
            <span class="navbar-brand"><i class="bi bi-whatsapp me-2"></i>WhatsApp Panel</span>
            <div class="d-flex align-items-center">
                <span id="statusBadge" class="badge bg-danger me-2">Bagli Degil</span>
                <span id="statusText" class="text-white me-3">Bagli Degil</span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Cikis</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-md-3 col-lg-2">
                <div class="list-group">
                    <a href="#" class="list-group-item list-group-item-action active" data-tab="dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
                    <a href="#" class="list-group-item list-group-item-action" data-tab="chats"><i class="bi bi-chat-dots me-2"></i>Sohbetler</a>
                    <a href="#" class="list-group-item list-group-item-action" data-tab="messages"><i class="bi bi-envelope me-2"></i>Mesajlar</a>
                    <a href="#" class="list-group-item list-group-item-action" data-tab="scripts"><i class="bi bi-code-slash me-2"></i>Scriptler</a>
                    <a href="#" class="list-group-item list-group-item-action" data-tab="auto-reply"><i class="bi bi-reply me-2"></i>Oto Yanit</a>
                    <a href="#" class="list-group-item list-group-item-action" data-tab="scheduled"><i class="bi bi-clock me-2"></i>Zamanli</a>
                    <a href="#" class="list-group-item list-group-item-action" data-tab="webhooks"><i class="bi bi-link-45deg me-2"></i>Webhooks</a>
                    <a href="#" class="list-group-item list-group-item-action" data-tab="logs"><i class="bi bi-journal-text me-2"></i>Loglar</a>
                </div>
            </div>

            <div class="col-md-9 col-lg-10">
                <!-- Dashboard -->
                <div id="tab-dashboard" class="tab-content">
                    <h4 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h4>

                    <div id="qrSection" class="card mb-4 d-none">
                        <div class="card-body text-center">
                            <h5>WhatsApp'a Baglanin</h5>
                            <p class="text-muted">Telefonunuzdan QR kodu tarayin</p>
                            <img id="qrCode" src="" alt="QR Code" style="max-width: 300px;">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3"><div class="card bg-primary text-white"><div class="card-body"><h6><i class="bi bi-chat-dots me-2"></i>Toplam Mesaj</h6><h2 id="statTotal">0</h2></div></div></div>
                        <div class="col-md-3"><div class="card bg-success text-white"><div class="card-body"><h6><i class="bi bi-send me-2"></i>Gonderilen</h6><h2 id="statSent">0</h2></div></div></div>
                        <div class="col-md-3"><div class="card bg-info text-white"><div class="card-body"><h6><i class="bi bi-inbox me-2"></i>Alinan</h6><h2 id="statReceived">0</h2></div></div></div>
                        <div class="col-md-3"><div class="card bg-warning text-dark"><div class="card-body"><h6><i class="bi bi-calendar-day me-2"></i>Bugun</h6><h2 id="statToday">0</h2></div></div></div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header"><i class="bi bi-lightning me-2"></i>Hizli Islemler</div>
                        <div class="card-body">
                            <button class="btn btn-outline-success me-2" onclick="reconnect()"><i class="bi bi-arrow-clockwise me-1"></i>Yeniden Baglan</button>
                            <button class="btn btn-outline-primary me-2" onclick="startSync()"><i class="bi bi-cloud-download me-1"></i>Mesajlari Senkronize Et</button>
                            <button class="btn btn-outline-danger" onclick="disconnect()"><i class="bi bi-x-circle me-1"></i>Baglanti Kes</button>
                        </div>
                    </div>

                    <div id="syncProgress" class="card mb-4 d-none">
                        <div class="card-body">
                            <h6><i class="bi bi-cloud-download me-2"></i>Senkronizasyon</h6>
                            <div class="progress mb-2">
                                <div id="syncProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                            </div>
                            <small id="syncStatus" class="text-muted">Bekleniyor...</small>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header"><i class="bi bi-gear me-2"></i>Ayarlar</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="settingDownloadMedia" onchange="updateSettings()">
                                        <label class="form-check-label" for="settingDownloadMedia">Medyalari Indir</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="settingSyncOnConnect" onchange="updateSettings()" checked>
                                        <label class="form-check-label" for="settingSyncOnConnect">Otomatik Senkronize</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Max Mesaj/Sohbet</label>
                                    <input type="number" class="form-control form-control-sm" id="settingMaxMessages" value="100" style="width:100px" onchange="updateSettings()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header"><i class="bi bi-google me-2"></i>Google Drive Entegrasyonu</div>
                        <div class="card-body">
                            <div id="driveStatus" class="mb-3">
                                <span class="text-muted">Yukleniyor...</span>
                            </div>
                            <button class="btn btn-primary me-2" onclick="migrateToDrive()" id="btnMigrateDrive" disabled>
                                <i class="bi bi-cloud-upload me-1"></i>Mevcut Medyalari Drive'a Tasi
                            </button>
                            <button class="btn btn-outline-secondary" onclick="checkDriveStatus()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Durumu Kontrol Et
                            </button>
                            <div id="driveProgress" class="mt-3 d-none">
                                <div class="progress">
                                    <div id="driveProgressBar" class="progress-bar" style="width: 0%"></div>
                                </div>
                                <small id="driveProgressText" class="text-muted mt-1"></small>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><i class="bi bi-clock-history me-2"></i>Son Mesajlar</div>
                        <div class="card-body">
                            <div id="recentMessages" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                </div>

                <!-- Chats -->
                <div id="tab-chats" class="tab-content d-none">
                    <h4 class="mb-4"><i class="bi bi-chat-dots me-2"></i>Sohbetler</h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <input type="text" class="form-control form-control-sm" id="chatSearch" placeholder="Ara...">
                                </div>
                                <div id="chatList" class="list-group list-group-flush" style="max-height: 500px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card" style="position: relative;">
                                <div class="chat-header">
                                    <div class="avatar"><i class="bi bi-person-fill"></i></div>
                                    <div class="chat-name" id="chatHeader">Bir sohbet secin</div>
                                </div>
                                <input type="hidden" id="selectedChatId">
                                <div id="chatMessages" class="chat-container"></div>
                                <button class="scroll-bottom-btn" id="scrollBottomBtn" onclick="scrollToBottom()">
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                                <div class="chat-footer">
                                    <form id="sendMessageForm" class="d-flex flex-grow-1" style="gap: 10px;">
                                        <input type="text" class="form-control" id="messageInput" placeholder="Mesaj yazin...">
                                        <button type="submit" class="btn btn-success btn-send"><i class="bi bi-send-fill"></i></button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="tab-messages" class="tab-content d-none">
                    <h4 class="mb-4"><i class="bi bi-envelope me-2"></i>Tum Mesajlar</h4>
                    <div class="card">
                        <div class="card-header">
                            <input type="text" class="form-control" id="messageSearch" placeholder="Mesaj ara...">
                        </div>
                        <div class="card-body table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>Tarih</th><th>Kimden</th><th>Mesaj</th><th>Tur</th></tr></thead>
                                <tbody id="messagesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Scripts -->
                <div id="tab-scripts" class="tab-content d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4><i class="bi bi-code-slash me-2"></i>Script Yonetimi</h4>
                        <button class="btn btn-success" onclick="showScriptEditor()"><i class="bi bi-plus-lg me-1"></i>Yeni Script</button>
                    </div>
                    <div class="alert alert-info">
                        <strong>Kullanilabilir:</strong>
                        <code>reply(msg)</code>, <code>sendMessage(chatId, msg)</code>, <code>msg.body</code>, <code>msg.from</code>, <code>msg.chatId</code>, <code>console.log()</code>, <code>fetch()</code>
                    </div>
                    <div class="card">
                        <div class="card-body table-responsive">
                            <table class="table">
                                <thead><tr><th>Ad</th><th>Aciklama</th><th>Tetikleyici</th><th>Durum</th><th>Calisma</th><th>Islemler</th></tr></thead>
                                <tbody id="scriptsList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Auto Reply -->
                <div id="tab-auto-reply" class="tab-content d-none">
                    <h4 class="mb-4"><i class="bi bi-reply me-2"></i>Otomatik Yanitlar</h4>
                    <div class="card mb-4">
                        <div class="card-header">Yeni Ekle</div>
                        <div class="card-body">
                            <form id="autoReplyForm" class="row g-3">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="triggerWord" placeholder="Tetikleyici kelime" required>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="autoResponse" placeholder="Yanit mesaji" required>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="matchType">
                                        <option value="contains">Icerir</option>
                                        <option value="exact">Tam Eslesme</option>
                                        <option value="startsWith">Baslar</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-success w-100">Ekle</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body table-responsive">
                            <table class="table">
                                <thead><tr><th>Tetikleyici</th><th>Yanit</th><th>Tip</th><th>Durum</th><th>Islem</th></tr></thead>
                                <tbody id="autoRepliesList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Scheduled -->
                <div id="tab-scheduled" class="tab-content d-none">
                    <h4 class="mb-4"><i class="bi bi-clock me-2"></i>Zamanli Mesajlar</h4>
                    <div class="card mb-4">
                        <div class="card-header">Yeni Zamanla</div>
                        <div class="card-body">
                            <form id="scheduledForm" class="row g-3">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="schedChatId" placeholder="Chat ID" required>
                                </div>
                                <div class="col-md-2">
                                    <input type="text" class="form-control" id="schedChatName" placeholder="Chat Adi">
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="schedMessage" placeholder="Mesaj" required>
                                </div>
                                <div class="col-md-2">
                                    <input type="datetime-local" class="form-control" id="schedTime" required>
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-success w-100">Zamanla</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body table-responsive">
                            <table class="table">
                                <thead><tr><th>Kime</th><th>Mesaj</th><th>Zaman</th><th>Durum</th><th>Islem</th></tr></thead>
                                <tbody id="scheduledList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Webhooks -->
                <div id="tab-webhooks" class="tab-content d-none">
                    <h4 class="mb-4"><i class="bi bi-link-45deg me-2"></i>Webhooks</h4>
                    <div class="card mb-4">
                        <div class="card-header">Yeni Webhook</div>
                        <div class="card-body">
                            <form id="webhookForm" class="row g-3">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="webhookName" placeholder="Ad" required>
                                </div>
                                <div class="col-md-5">
                                    <input type="url" class="form-control" id="webhookUrl" placeholder="URL" required>
                                </div>
                                <div class="col-md-2">
                                    <input type="text" class="form-control" id="webhookEvents" placeholder="Events" value="message">
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-success w-100">Ekle</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body table-responsive">
                            <table class="table">
                                <thead><tr><th>Ad</th><th>URL</th><th>Events</th><th>Durum</th><th>Islem</th></tr></thead>
                                <tbody id="webhooksList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Logs -->
                <div id="tab-logs" class="tab-content d-none">
                    <h4 class="mb-4"><i class="bi bi-journal-text me-2"></i>Loglar</h4>
                    <div class="mb-3">
                        <button class="btn btn-outline-secondary btn-sm me-1" onclick="loadLogs()">Tumu</button>
                        <button class="btn btn-outline-primary btn-sm me-1" onclick="loadLogs('message')">Mesajlar</button>
                        <button class="btn btn-outline-success btn-sm me-1" onclick="loadLogs('whatsapp')">WhatsApp</button>
                        <button class="btn btn-outline-info btn-sm me-1" onclick="loadLogs('sync')">Sync</button>
                        <button class="btn btn-outline-warning btn-sm" onclick="loadLogs('webhook')">Webhook</button>
                    </div>
                    <div class="card">
                        <div class="card-body table-responsive">
                            <table class="table table-sm">
                                <thead><tr><th>Zaman</th><th>Seviye</th><th>Kategori</th><th>Mesaj</th></tr></thead>
                                <tbody id="logsList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Editor Modal -->
    <div class="modal fade" id="scriptEditorModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Script Duzenleyici</h5>
                    <button type="button" class="btn-close" onclick="hideScriptEditor()"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="scriptName" placeholder="Script Adi">
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control" id="scriptDescription" placeholder="Aciklama">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="scriptTriggerType">
                                <option value="message">Mesaj Geldiginde</option>
                                <option value="manual">Manuel</option>
                            </select>
                        </div>
                    </div>
                    <div id="scriptEditor" style="height: 400px; border: 1px solid #ccc;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideScriptEditor()">Iptal</button>
                    <button type="button" class="btn btn-info" onclick="testScript()">Test Et</button>
                    <button type="button" class="btn btn-success" onclick="saveScript()">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
